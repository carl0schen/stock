# .github/workflows/generate-rss.yml
name: Generate RSS Feed

on:
  push:
    branches: [ main ]
    paths:
      - '20*/[0-9][0-9]/[0-9][0-9]/**'  # ç›£æ§æ–°çš„è³‡æ–™å¤¾çµæ§‹ 2025/09/05/
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  generate-rss:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for other workflows
      if: github.event_name == 'push'
      run: |
        echo "ç­‰å¾…å…¶ä»– workflow å®Œæˆ..."
        sleep 60  # ç­‰å¾… 60 ç§’è®“å…¶ä»– workflow å…ˆåŸ·è¡Œ
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿æ’åº
        ref: main  # ç¢ºä¿æ‹‰å–æœ€æ–°çš„ main åˆ†æ”¯

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate RSS Feed
      run: |
        cat > generate-rss.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // RSS æ¨¡æ¿
        const rssHeader = `<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
          <channel>
            <title>å°è‚¡ç›¤å¾Œ - æ³•äººè²·è³£è¶…æ•´ç†</title>
            <link>https://stock.may.tw</link>
            <description>åˆ©ç”¨AIå½™æ•´å°è‚¡ç›¤å¾Œè³‡è¨Šï¼Œå¿«é€Ÿæƒææ³•äººç•¶æ—¥ç±Œç¢¼ã€‚</description>
            <language>zh-TW</language>
            <atom:link href="https://stock.may.tw/rss.xml" rel="self" type="application/rss+xml"/>
            <lastBuildDate>${new Date().toUTCString()}</lastBuildDate>`;

        const rssFooter = `  </channel>
        </rss>`;

        // ç²å–æ‰€æœ‰æ—¥æœŸè³‡æ–™å¤¾
        const getAllDateFolders = () => {
          const folders = [];
          
          // æƒæå¹´ä»½è³‡æ–™å¤¾ (2024, 2025, etc.)
          const yearFolders = fs.readdirSync('.')
            .filter(item => {
              const stat = fs.statSync(item);
              return stat.isDirectory() && /^20\d{2}$/.test(item); // åŒ¹é… 20XX å¹´ä»½
            });
          
          yearFolders.forEach(year => {
            const yearPath = `./${year}`;
            if (fs.existsSync(yearPath)) {
              // æƒææœˆä»½è³‡æ–™å¤¾ (01, 02, ..., 12)
              const monthFolders = fs.readdirSync(yearPath)
                .filter(item => {
                  const stat = fs.statSync(path.join(yearPath, item));
                  return stat.isDirectory() && /^(0[1-9]|1[0-2])$/.test(item); // åŒ¹é… 01-12
                });
              
              monthFolders.forEach(month => {
                const monthPath = path.join(yearPath, month);
                if (fs.existsSync(monthPath)) {
                  // æƒææ—¥æœŸè³‡æ–™å¤¾ (01, 02, ..., 31)
                  const dayFolders = fs.readdirSync(monthPath)
                    .filter(item => {
                      const stat = fs.statSync(path.join(monthPath, item));
                      return stat.isDirectory() && /^(0[1-9]|[12]\d|3[01])$/.test(item); // åŒ¹é… 01-31
                    });
                  
                  dayFolders.forEach(day => {
                    const fullPath = `${year}/${month}/${day}`;
                    const indexPath = path.join(monthPath, day, 'index.html');
                    
                    // ç¢ºèªè©²è·¯å¾‘æœ‰ index.html
                    if (fs.existsSync(indexPath)) {
                      folders.push({
                        path: fullPath,
                        dateStr: `${year}${month}${day}`, // ç”¨æ–¼æ’åºçš„æ—¥æœŸå­—ä¸²
                        year: year,
                        month: month,
                        day: day
                      });
                    }
                  });
                }
              });
            }
          });
          
          // æŒ‰æ—¥æœŸé™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          return folders.sort((a, b) => b.dateStr.localeCompare(a.dateStr));
        };

        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        const formatDate = (folderInfo) => {
          return `${folderInfo.year}å¹´${folderInfo.month}æœˆ${folderInfo.day}æ—¥`;
        };

        // è½‰æ›ç‚º RSS æ—¥æœŸæ ¼å¼
        const toRSSDate = (folderInfo) => {
          const date = new Date(folderInfo.year, folderInfo.month - 1, folderInfo.day, 16, 30, 0); // ä¸‹åˆ4é»åŠ
          return date.toUTCString();
        };

        // ç”Ÿæˆ RSS é …ç›®
        const generateRSSItems = (folders) => {
          return folders.slice(0, 10).map(folderInfo => { // åªå–æœ€æ–° 10 ç­†
            const title = `${formatDate(folderInfo)} æ³•äººè²·è³£è¶…æ•´ç†`;
            const link = `https://stock.may.tw/${folderInfo.path}/`;
            const pubDate = toRSSDate(folderInfo);
            const guid = `https://stock.may.tw/${folderInfo.path}/`;
            
            return `    <item>
              <title>${title}</title>
              <link>${link}</link>
              <description>æœ¬æ–‡æ•´ç†äº†${formatDate(folderInfo)}å°è‚¡ç›¤å¾Œä¸‰å¤§æ³•äººçš„äº¤æ˜“å‹•å‘ã€‚</description>
              <pubDate>${pubDate}</pubDate>
              <guid isPermaLink="true">${guid}</guid>
            </item>`;
          }).join('\n');
        };

        // ä¸»ç¨‹åº
        const main = () => {
          try {
            const folders = getAllDateFolders();
            console.log(`æ‰¾åˆ° ${folders.length} å€‹æ—¥æœŸè³‡æ–™å¤¾`);
            
            if (folders.length === 0) {
              console.log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ—¥æœŸè³‡æ–™å¤¾');
              return;
            }
            
            // é¡¯ç¤ºæ‰¾åˆ°çš„è³‡æ–™å¤¾ï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
            console.log('æœ€æ–°çš„å¹¾å€‹è³‡æ–™å¤¾:');
            folders.slice(0, 5).forEach(folder => {
              console.log(`  ${folder.path} (${folder.dateStr})`);
            });

            const rssItems = generateRSSItems(folders);
            const rssContent = `${rssHeader}\n${rssItems}\n${rssFooter}`;
            
            fs.writeFileSync('rss.xml', rssContent, 'utf8');
            console.log('RSS feed ç”Ÿæˆå®Œæˆ');
            console.log(`åŒ…å« ${Math.min(folders.length, 10)} å€‹é …ç›®`);
          } catch (error) {
            console.error('ç”Ÿæˆ RSS æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            process.exit(1);
          }
        };

        main();
        EOF

        node generate-rss.js

    - name: Commit and push RSS file with retry
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add rss.xml
        
        if git diff --staged --quiet; then
          echo "RSS æª”æ¡ˆæ²’æœ‰è®Šæ›´"
          exit 0
        fi
        
        # æäº¤è®Šæ›´
        git commit -m "ğŸ¤– Auto-update RSS feed"
        
        # æ¨é€æ™‚åŠ å…¥é‡è©¦æ©Ÿåˆ¶
        max_attempts=3
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "å˜—è©¦æ¨é€ RSS æ›´æ–° (ç¬¬ $attempt æ¬¡)..."
          
          if git push; then
            echo "âœ… RSS æ¨é€æˆåŠŸ!"
            exit 0
          else
            echo "âŒ æ¨é€å¤±æ•—ï¼Œæº–å‚™é‡è©¦..."
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ ($max_attempts)ï¼Œæ”¾æ£„æ¨é€"
              exit 1
            fi
            
            echo "ğŸ”„ æ‹‰å–é ç«¯è®Šæ›´ä¸¦é‡æ–°å˜—è©¦..."
            # å…ˆæ‹‰å–æœ€æ–°è®Šæ›´
            if git pull --rebase origin main; then
              echo "âœ… æˆåŠŸåŒæ­¥é ç«¯è®Šæ›´"
            else
              echo "âš ï¸ åŒæ­¥æ™‚å‡ºç¾å•é¡Œï¼Œå˜—è©¦å¼·åˆ¶åŒæ­¥..."
              git rebase --abort 2>/dev/null || true
              git fetch origin main
              git reset --hard origin/main
              git add rss.xml
              git commit -m "ğŸ¤– Auto-update RSS feed"
            fi
            
            # ç­‰å¾…éš¨æ©Ÿæ™‚é–“é¿å…è¡çª
            sleep_time=$((5 + RANDOM % 5))  # 5-9ç§’éš¨æ©Ÿç­‰å¾…
            echo "â³ ç­‰å¾… $sleep_time ç§’å¾Œé‡è©¦..."
            sleep $sleep_time
          fi
          
          attempt=$((attempt + 1))
        done
