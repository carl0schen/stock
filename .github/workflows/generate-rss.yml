# .github/workflows/generate-rss.yml
name: Generate RSS Feed

on:
  push:
    branches: [ main ]
    paths:
      - '20**/**/index.html' # ç›£æ§æ‰€æœ‰ä»¥ '20' é–‹é ­çš„è³‡æ–™å¤¾ä¸‹çš„ index.html è®Šå‹•
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  generate-rss:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for other workflows
      if: github.event_name == 'push'
      run: |
        echo "ç­‰å¾…å…¶ä»– workflow å®Œæˆ..."
        sleep 30 # ç­‰å¾… 30 ç§’è®“å…¶ä»– workflow å…ˆåŸ·è¡Œ
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿æ’åº
        ref: main  # ç¢ºä¿æ‹‰å–æœ€æ–°çš„ main åˆ†æ”¯

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate RSS Feed
      run: |
        # ä½¿ç”¨ 'EOF' æ¨™èªŒï¼Œä¸¦å°‡è…³æœ¬å¯«å…¥æª”æ¡ˆ
        cat > generate-rss.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const { XMLBuilder } = require('fast-xml-parser');

        const builder = new XMLBuilder({
          format: true,
          ignoreAttributes: false
        });

        const rssTemplate = {
          rss: {
            '@_version': '2.0',
            '@_xmlns:atom': 'http://www.w3.org/2005/Atom',
            channel: {
              title: 'å°è‚¡ç›¤å¾Œ - æ³•äººè²·è³£è¶…æ•´ç†',
              link: 'https://stock.may.tw',
              description: 'åˆ©ç”¨AIå½™æ•´å°è‚¡ç›¤å¾Œè³‡è¨Šï¼Œå¿«é€Ÿæƒææ³•äººç•¶æ—¥ç±Œç¢¼ã€‚',
              language: 'zh-TW',
              'atom:link': {
                '@_href': 'https://stock.may.tw/rss.xml',
                '@_rel': 'self',
                '@_type': 'application/rss+xml'
              },
              lastBuildDate: new Date().toUTCString(),
              item: []
            }
          }
        };

        const getArticleFolders = (dirPath) => {
          let folders = [];
          const items = fs.readdirSync(dirPath, { withFileTypes: true });

          for (const item of items) {
            if (item.isDirectory()) {
              const fullPath = path.join(dirPath, item.name);
              if (/^\d{4}$/.test(item.name)) {
                folders = folders.concat(getArticleFolders(fullPath));
              } else if (/^\d{2}$/.test(item.name)) {
                if (fs.existsSync(path.join(fullPath, 'index.html'))) {
                  folders.push(fullPath);
                } else {
                  folders = folders.concat(getArticleFolders(fullPath));
                }
              }
            }
          }
          return folders;
        };

        const parseDateFromPath = (pathStr) => {
          const parts = pathStr.split(path.sep).filter(p => p !== '');
          if (parts.length >= 3) {
            const year = parts[parts.length - 3];
            const month = parts[parts.length - 2];
            const day = parts[parts.length - 1];
            return `${year}${month}${day}`;
          }
          return null;
        };

        const formatDate = (dateStr) => {
          const year = dateStr.substring(0, 4);
          const month = dateStr.substring(4, 6);
          const day = dateStr.substring(6, 8);
          return `${year}å¹´${month}æœˆ${day}æ—¥`;
        };

        const toRSSDate = (dateStr) => {
          const year = dateStr.substring(0, 4);
          const month = dateStr.substring(4, 6);
          const day = dateStr.substring(6, 8);
          const date = new Date(year, month - 1, day, 16, 30, 0);
          return date.toUTCString();
        };

        const generateRSSItems = (folders) => {
          return folders.slice(0, 10).map(folder => {
            const dateStr = parseDateFromPath(folder);
            if (!dateStr) return null;
            
            return {
              title: `${formatDate(dateStr)} æ³•äººè²·è³£è¶…æ•´ç†`,
              link: `https://stock.may.tw/${folder}/`,
              description: `æœ¬æ–‡æ•´ç†äº†${formatDate(dateStr)}å°è‚¡ç›¤å¾Œä¸‰å¤§æ³•äººçš„äº¤æ˜“å‹•å‘ã€‚`,
              pubDate: toRSSDate(dateStr),
              guid: {
                '@_isPermaLink': 'true',
                '#text': `https://stock.may.tw/${folder}/`
              }
            };
          }).filter(item => item !== null);
        };

        const main = () => {
          try {
            const folders = getArticleFolders('.');
            console.log(`æ‰¾åˆ° ${folders.length} å€‹æ–‡ç« è³‡æ–™å¤¾`);
            
            folders.sort((a, b) => parseDateFromPath(b).localeCompare(parseDateFromPath(a)));

            if (folders.length === 0) {
              console.log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ç« è³‡æ–™å¤¾');
              return;
            }

            rssTemplate.rss.channel.item = generateRSSItems(folders);
            const xmlContent = builder.build(rssTemplate);
            
            fs.writeFileSync('rss.xml', xmlContent, 'utf8');
            console.log('RSS feed ç”Ÿæˆå®Œæˆ');
            console.log(`åŒ…å« ${Math.min(folders.length, 10)} å€‹é …ç›®`);
          } catch (error) {
            console.error('ç”Ÿæˆ RSS æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            process.exit(1);
          }
        };

        main();
        EOF
        
        # å®‰è£ fast-xml-parser
        npm install fast-xml-parser --prefix .github/workflows
        node generate-rss.js

    - name: Commit and push RSS file with retry
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add rss.xml
        
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ¤– Auto-update RSS feed"
          git push
        else
          echo "RSS æª”æ¡ˆæ²’æœ‰è®Šæ›´"
          exit 0
        fi
        