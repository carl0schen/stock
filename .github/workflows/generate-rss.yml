# .github/workflows/generate-rss.yml
name: Generate RSS Feed

on:
  push:
    branches: [ main ]
    paths:
      - '20*/[0-9][0-9]/[0-9][0-9]/**'        # æ—¥å ±
      - '20*/weekly/[0-9][0-9]/**'            # é€±å ±
      - '20*/monthly/[0-9][0-9]/**'           # æœˆå ±
  workflow_dispatch:

jobs:
  generate-rss:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for other workflows
      if: github.event_name == 'push'
      run: |
        echo "ç­‰å¾…å…¶ä»– workflow å®Œæˆ..."
        sleep 60
    
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: main

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Generate Unified RSS Feed
      run: |
        cat > generate-rss.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // RSS æ¨¡æ¿
        const rssHeader = `<?xml version="1.0" encoding="UTF-8"?>
        <rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
          <channel>
            <title>å°è‚¡ç›¤å¾Œ - æ³•äººè²·è³£è¶…æ•´ç†</title>
            <link>https://stock.may.tw</link>
            <description>åˆ©ç”¨AIå½™æ•´å°è‚¡ç›¤å¾Œè³‡è¨Šï¼Œå¿«é€ŸæŒæ¡å¸‚å ´å‹•å‘ã€‚</description>
            <language>zh-TW</language>
            <atom:link href="https://stock.may.tw/rss.xml" rel="self" type="application/rss+xml"/>
            <lastBuildDate>${new Date().toUTCString()}</lastBuildDate>`;

        const rssFooter = `  </channel>
        </rss>`;

        // ç²å–æ‰€æœ‰æ–‡ç« 
        const getAllArticles = () => {
          const articles = [];
          
          const yearFolders = fs.readdirSync('.')
            .filter(item => fs.statSync(item).isDirectory() && /^20\d{2}$/.test(item));
          
          yearFolders.forEach(year => {
            const yearPath = `./${year}`;
            
            // === æƒææ—¥å ± ===
            const monthFolders = fs.readdirSync(yearPath)
              .filter(item => {
                const itemPath = path.join(yearPath, item);
                return fs.statSync(itemPath).isDirectory() && /^(0[1-9]|1[0-2])$/.test(item);
              });
            
            monthFolders.forEach(month => {
              const monthPath = path.join(yearPath, month);
              if (fs.existsSync(monthPath)) {
                const dayFolders = fs.readdirSync(monthPath)
                  .filter(item => {
                    const itemPath = path.join(monthPath, item);
                    return fs.statSync(itemPath).isDirectory() && /^(0[1-9]|[12]\d|3[01])$/.test(item);
                  });
                
                dayFolders.forEach(day => {
                  const indexPath = path.join(monthPath, day, 'index.html');
                  if (fs.existsSync(indexPath)) {
                    const date = new Date(year, month - 1, day, 16, 30, 0); // ä¸‹åˆ4:30
                    // å»æ‰å‰å°0çš„é¡¯ç¤ºæ ¼å¼
                    const displayMonth = parseInt(month);
                    const displayDay = parseInt(day);
                    articles.push({
                      path: `${year}/${month}/${day}`,
                      title: `${year}å¹´${displayMonth}æœˆ${displayDay}æ—¥ æ³•äººè²·è³£è¶…æ•´ç†`,
                      description: `æœ¬æ–‡æ•´ç†äº†${year}å¹´${displayMonth}æœˆ${displayDay}æ—¥å°è‚¡ç›¤å¾Œä¸‰å¤§æ³•äººçš„äº¤æ˜“å‹•å‘ã€‚`,
                      date: date,
                      sortKey: date.getTime(),
                      type: 'daily'
                    });
                  }
                });
              }
            });
            
            // === æƒæé€±å ± ===
            const weeklyPath = path.join(yearPath, 'weekly');
            if (fs.existsSync(weeklyPath)) {
              const weekFolders = fs.readdirSync(weeklyPath)
                .filter(item => {
                  const itemPath = path.join(weeklyPath, item);
                  return fs.statSync(itemPath).isDirectory() && /^[0-5]\d$/.test(item);
                });
              
              weekFolders.forEach(week => {
                const indexPath = path.join(weeklyPath, week, 'index.html');
                if (fs.existsSync(indexPath)) {
                  // è¨ˆç®—è©²é€±çš„å¤§è‡´æ—¥æœŸ (é€±æ—¥æ™šä¸Š8é»)
                  const weekNum = parseInt(week);
                  const jan1 = new Date(year, 0, 1);
                  const firstSunday = new Date(jan1);
                  firstSunday.setDate(jan1.getDate() + (7 - jan1.getDay()) % 7);
                  const weekDate = new Date(firstSunday);
                  weekDate.setDate(firstSunday.getDate() + (weekNum - 1) * 7);
                  weekDate.setHours(20, 0, 0); // é€±æ—¥æ™šä¸Š8é»
                  
                  articles.push({
                    path: `${year}/weekly/${week}`,
                    title: `${year}å¹´ç¬¬${weekNum}é€± æ³•äººè²·è³£è¶…æ•´ç†é€±å ±`,
                    description: `æœ¬æ–‡æ•´ç†äº†${year}å¹´ç¬¬${weekNum}é€±ä¸‰å¤§æ³•äººçš„äº¤æ˜“å‹•å‘ã€‚`,
                    date: weekDate,
                    sortKey: weekDate.getTime(),
                    type: 'weekly'
                  });
                }
              });
            }
            
            // === æƒææœˆå ± ===
            const monthlyPath = path.join(yearPath, 'monthly');
            if (fs.existsSync(monthlyPath)) {
              const monthFolders = fs.readdirSync(monthlyPath)
                .filter(item => {
                  const itemPath = path.join(monthlyPath, item);
                  return fs.statSync(itemPath).isDirectory() && /^(0[1-9]|1[0-2])$/.test(item);
                });
              
              monthFolders.forEach(month => {
                const indexPath = path.join(monthlyPath, month, 'index.html');
                if (fs.existsSync(indexPath)) {
                  // æœˆå ±è¨­ç‚ºè©²æœˆæœ€å¾Œä¸€å¤©æ™šä¸Š9é»
                  const date = new Date(year, month, 0, 21, 0, 0); // æœˆåº•æ™šä¸Š9é»
                  
                  articles.push({
                    path: `${year}/monthly/${month}`,
                    title: `${year}å¹´${month}æœˆ æ³•äººè²·è³£è¶…æ•´ç†æœˆå ±`,
                    description: `æœ¬æ–‡æ•´ç†äº†${year}å¹´${month}æœˆä¸‰å¤§æ³•äººçš„äº¤æ˜“å‹•å‘ã€‚`,
                    date: date,
                    sortKey: date.getTime(),
                    type: 'monthly'
                  });
                }
              });
            }
          });
          
          // æŒ‰æ™‚é–“é™åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          return articles.sort((a, b) => b.sortKey - a.sortKey);
        };

        // ç”Ÿæˆ RSS é …ç›®
        const generateRSSItems = (articles) => {
          return articles.slice(0, 20).map(article => { // å–æœ€æ–° 20 ç¯‡
            const link = `https://stock.may.tw/${article.path}/`;
            const guid = `https://stock.may.tw/${article.path}/`;
            
            return `    <item>
              <title>${article.title}</title>
              <link>${link}</link>
              <description>${article.description}</description>
              <pubDate>${article.date.toUTCString()}</pubDate>
              <guid isPermaLink="true">${guid}</guid>
            </item>`;
          }).join('\n');
        };

        // ä¸»ç¨‹åº
        const main = () => {
          try {
            const articles = getAllArticles();
            console.log(`æ‰¾åˆ°ç¸½å…± ${articles.length} ç¯‡æ–‡ç« `);
            
            // é¡¯ç¤ºå„é¡å‹æ–‡ç« æ•¸é‡
            const dailyCount = articles.filter(a => a.type === 'daily').length;
            const weeklyCount = articles.filter(a => a.type === 'weekly').length;
            const monthlyCount = articles.filter(a => a.type === 'monthly').length;
            
            console.log(`æ—¥å ±: ${dailyCount} ç¯‡`);
            console.log(`é€±å ±: ${weeklyCount} ç¯‡`);
            console.log(`æœˆå ±: ${monthlyCount} ç¯‡`);
            
            if (articles.length === 0) {
              console.log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ç« ');
              return;
            }
            
            // é¡¯ç¤ºæœ€æ–°çš„å¹¾ç¯‡æ–‡ç« 
            console.log('\næœ€æ–°çš„æ–‡ç« :');
            articles.slice(0, 5).forEach((article, index) => {
              console.log(`  ${index + 1}. [${article.type}] ${article.title}`);
            });

            const rssItems = generateRSSItems(articles);
            const rssContent = `${rssHeader}\n${rssItems}\n${rssFooter}`;
            
            fs.writeFileSync('rss.xml', rssContent, 'utf8');
            console.log(`\nRSS feed ç”Ÿæˆå®Œæˆï¼ŒåŒ…å«æœ€æ–° ${Math.min(articles.length, 20)} ç¯‡æ–‡ç« `);
          } catch (error) {
            console.error('ç”Ÿæˆ RSS æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            process.exit(1);
          }
        };

        main();
        EOF

        node generate-rss.js

    - name: Commit and push RSS file with retry
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add rss.xml
        
        if git diff --staged --quiet; then
          echo "RSS æª”æ¡ˆæ²’æœ‰è®Šæ›´"
          exit 0
        fi
        
        git commit -m "ğŸ¤– Auto-update RSS feed"
        
        # æ¨é€é‡è©¦æ©Ÿåˆ¶
        max_attempts=3
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "å˜—è©¦æ¨é€ RSS æ›´æ–° (ç¬¬ $attempt æ¬¡)..."
          
          if git push; then
            echo "âœ… RSS æ¨é€æˆåŠŸ!"
            exit 0
          else
            echo "âŒ æ¨é€å¤±æ•—ï¼Œæº–å‚™é‡è©¦..."
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ å·²é”æœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œæ”¾æ£„æ¨é€"
              exit 1
            fi
            
            echo "ğŸ”„ æ‹‰å–é ç«¯è®Šæ›´ä¸¦é‡æ–°å˜—è©¦..."
            if git pull --rebase origin main; then
              echo "âœ… æˆåŠŸåŒæ­¥é ç«¯è®Šæ›´"
            else
              echo "âš ï¸ åŒæ­¥æ™‚å‡ºç¾å•é¡Œï¼Œå˜—è©¦å¼·åˆ¶åŒæ­¥..."
              git rebase --abort 2>/dev/null || true
              git fetch origin main
              git reset --hard origin/main
              git add rss.xml
              git commit -m "ğŸ¤– Auto-update RSS feed"
            fi
            
            sleep_time=$((5 + RANDOM % 5))
            echo "â³ ç­‰å¾… $sleep_time ç§’å¾Œé‡è©¦..."
            sleep $sleep_time
          fi
          
          attempt=$((attempt + 1))
        done
        
