name: Generate Sitemap

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: [ main ]
    paths:
      - '20*/*/index.html'      # æ—¥å ±
      - '20*/weekly/*/index.html'   # é€±å ±
      - '20*/monthly/*/index.html'  # æœˆå ±
      - '20*/**'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ï¼Œç”¨æ–¼æº–ç¢ºçš„ä¿®æ”¹æ™‚é–“
        
    - name: Generate sitemap
      run: |
        echo "é–‹å§‹ç”Ÿæˆ sitemap..."
        echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
        echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml
        
        # è™•ç†é¦–é ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "index.html" ]; then
          last_mod=$(date -r index.html +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          echo "  <url>" >> sitemap.xml
          echo "    <loc>https://stock.may.tw/</loc>" >> sitemap.xml
          echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
          echo "    <changefreq>daily</changefreq>" >> sitemap.xml
          echo "    <priority>1.0</priority>" >> sitemap.xml
          echo "  </url>" >> sitemap.xml
          echo "å·²åŠ å…¥é¦–é "
        fi
        
        # åŠ å…¥ RSS feed
        echo "  <url>" >> sitemap.xml
        echo "    <loc>https://stock.may.tw/rss.xml</loc>" >> sitemap.xml
        echo "    <lastmod>$(date +%Y-%m-%d)</lastmod>" >> sitemap.xml
        echo "    <changefreq>daily</changefreq>" >> sitemap.xml
        echo "    <priority>0.8</priority>" >> sitemap.xml
        echo "  </url>" >> sitemap.xml
        echo "å·²åŠ å…¥ RSS feed"
        
        # åŠ å…¥æœå°‹é é¢
        echo "  <url>" >> sitemap.xml
        echo "    <loc>https://stock.may.tw/search/</loc>" >> sitemap.xml
        echo "    <lastmod>$(date +%Y-%m-%d)</lastmod>" >> sitemap.xml
        echo "    <changefreq>monthly</changefreq>" >> sitemap.xml
        echo "    <priority>0.7</priority>" >> sitemap.xml
        echo "  </url>" >> sitemap.xml
        echo "å·²åŠ å…¥æœå°‹é é¢"
        
        # åŠ å…¥æ–°èé é¢
        echo "  <url>" >> sitemap.xml
        echo "    <loc>https://stock.may.tw/news/</loc>" >> sitemap.xml
        echo "    <lastmod>$(date +%Y-%m-%d)</lastmod>" >> sitemap.xml
        echo "    <changefreq>daily</changefreq>" >> sitemap.xml
        echo "    <priority>0.7</priority>" >> sitemap.xml
        echo "  </url>" >> sitemap.xml
        echo "å·²åŠ å…¥æ–°èé é¢"
        
        # æ”¶é›†ä¸¦åŠ å…¥é€±å ±ï¼ˆä¸å—365å¤©é™åˆ¶ï¼‰
        weekly_count=0
        echo "æ­£åœ¨æ”¶é›†é€±å ±..."
        for year_dir in 20*/; do
          if [[ -d "$year_dir" && ${year_dir%/} =~ ^20[0-9]{2}$ ]]; then
            weekly_dir="${year_dir}weekly/"
            if [[ -d "$weekly_dir" ]]; then
              for week_dir in "${weekly_dir}"*/; do
                if [[ -d "$week_dir" && $(basename "$week_dir") =~ ^[0-9]{1,2}$ ]] && [ -f "${week_dir}index.html" ]; then
                  folder_path="${week_dir%/}"
                  last_mod=$(date -r "${folder_path}/index.html" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
                  
                  year=$(echo "$folder_path" | cut -d'/' -f1)
                  week=$(echo "$folder_path" | cut -d'/' -f3)
                  
                  echo "  <url>" >> sitemap.xml
                  echo "    <loc>https://stock.may.tw/$folder_path/</loc>" >> sitemap.xml
                  echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
                  echo "    <changefreq>monthly</changefreq>" >> sitemap.xml
                  echo "    <priority>0.8</priority>" >> sitemap.xml
                  echo "  </url>" >> sitemap.xml
                  
                  weekly_count=$((weekly_count + 1))
                  echo "å·²è™•ç†é€±å ±: ${year}å¹´ç¬¬${week}é€±"
                fi
              done
            fi
          fi
        done
        
        # æ”¶é›†ä¸¦åŠ å…¥æœˆå ±ï¼ˆä¸å—365å¤©é™åˆ¶ï¼‰
        monthly_count=0
        echo "æ­£åœ¨æ”¶é›†æœˆå ±..."
        for year_dir in 20*/; do
          if [[ -d "$year_dir" && ${year_dir%/} =~ ^20[0-9]{2}$ ]]; then
            monthly_dir="${year_dir}monthly/"
            if [[ -d "$monthly_dir" ]]; then
              for month_dir in "${monthly_dir}"*/; do
                if [[ -d "$month_dir" && $(basename "$month_dir") =~ ^(0[1-9]|1[0-2])$ ]] && [ -f "${month_dir}index.html" ]; then
                  folder_path="${month_dir%/}"
                  last_mod=$(date -r "${folder_path}/index.html" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
                  
                  year=$(echo "$folder_path" | cut -d'/' -f1)
                  month=$(echo "$folder_path" | cut -d'/' -f3)
                  
                  echo "  <url>" >> sitemap.xml
                  echo "    <loc>https://stock.may.tw/$folder_path/</loc>" >> sitemap.xml
                  echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
                  echo "    <changefreq>yearly</changefreq>" >> sitemap.xml
                  echo "    <priority>0.9</priority>" >> sitemap.xml
                  echo "  </url>" >> sitemap.xml
                  
                  monthly_count=$((monthly_count + 1))
                  echo "å·²è™•ç†æœˆå ±: ${year}å¹´${month}æœˆ"
                fi
              done
            fi
          fi
        done
        
        # è¨ˆç®—365å¤©å‰çš„æ—¥æœŸ
        cutoff_date=$(date -d "365 days ago" +%s)
        echo "é™åˆ¶æ—¥æœŸï¼š$(date -d @$cutoff_date +%Y-%m-%d)ï¼ˆ365å¤©å‰ï¼‰"
        
        # æ”¶é›†æ‰€æœ‰æ—¥æœŸè³‡æ–™å¤¾ (æ–°çµæ§‹: YYYY/MM/DD/)
        folders=()
        article_count=0
        
        for year_dir in 20*/; do
          if [[ -d "$year_dir" && ${year_dir%/} =~ ^20[0-9]{2}$ ]]; then
            for month_dir in "${year_dir}"*/; do
              if [[ -d "$month_dir" && $(basename "$month_dir") =~ ^(0[1-9]|1[0-2])$ ]]; then
                for day_dir in "${month_dir}"*/; do
                  if [[ -d "$day_dir" && $(basename "$day_dir") =~ ^(0[1-9]|[12][0-9]|3[01])$ ]] && [ -f "${day_dir}index.html" ]; then
                    # ç§»é™¤æœ«å°¾çš„æ–œç·šä¸¦åŠ å…¥é™£åˆ—
                    folder_path="${day_dir%/}"
                    
                    # å¾è·¯å¾‘è§£ææ—¥æœŸä¸¦æª¢æŸ¥æ˜¯å¦åœ¨365å¤©å…§
                    year=$(echo "$folder_path" | cut -d'/' -f1)
                    month=$(echo "$folder_path" | cut -d'/' -f2)
                    day=$(echo "$folder_path" | cut -d'/' -f3)
                    
                    # æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨365å¤©å…§
                    folder_date=$(date -d "${year}-${month}-${day}" +%s 2>/dev/null || continue)
                    
                    if [ $folder_date -ge $cutoff_date ]; then
                      folders+=("$folder_path")
                      article_count=$((article_count + 1))
                    fi
                  fi
                done
              fi
            done
          fi
        done
        
        echo "æ‰¾åˆ° $article_count ç¯‡365å¤©å…§çš„æ–‡ç« "
        
        # æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰- æ ¹æ“šè·¯å¾‘æ’åº
        IFS=$'\n' sorted_folders=($(printf '%s\n' "${folders[@]}" | sort -r))
        unset IFS
        
        # ç‚ºæ¯å€‹è³‡æ–™å¤¾ç”Ÿæˆ sitemap æ¢ç›®
        count=0
        for folder in "${sorted_folders[@]}"; do
          if [ -f "${folder}/index.html" ]; then
            # ç²å–æª”æ¡ˆä¿®æ”¹æ™‚é–“
            last_mod=$(date -r "${folder}/index.html" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
            
            # å¾è·¯å¾‘è§£ææ—¥æœŸ (YYYY/MM/DD)
            year=$(echo "$folder" | cut -d'/' -f1)
            month=$(echo "$folder" | cut -d'/' -f2)
            day=$(echo "$folder" | cut -d'/' -f3)
            
            # è¨ˆç®—å¤©æ•¸å·®ç•°ä¾†è¨­å®šå„ªå…ˆç´šå’Œæ›´æ–°é »ç‡
            folder_date=$(date -d "${year}-${month}-${day}" +%s 2>/dev/null || date +%s)
            current_date=$(date +%s)
            days_diff=$(( (current_date - folder_date) / 86400 ))
            
            # æ ¹æ“šè³‡æ–™æ–°èˆŠè¨­å®šåƒæ•¸ï¼ˆé‡å°è‚¡ç¥¨åˆ†æå„ªåŒ–ï¼‰
            if [ $days_diff -le 1 ]; then
              priority="1.0"
              changefreq="hourly"
            elif [ $days_diff -le 7 ]; then
              priority="0.9"
              changefreq="daily"
            elif [ $days_diff -le 30 ]; then
              priority="0.8"
              changefreq="weekly"
            elif [ $days_diff -le 90 ]; then
              priority="0.6"
              changefreq="monthly"
            elif [ $days_diff -le 180 ]; then
              priority="0.4"
              changefreq="monthly"
            else
              priority="0.3"
              changefreq="yearly"
            fi
            
            echo "  <url>" >> sitemap.xml
            echo "    <loc>https://stock.may.tw/$folder/</loc>" >> sitemap.xml
            echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
            echo "    <changefreq>$changefreq</changefreq>" >> sitemap.xml
            echo "    <priority>$priority</priority>" >> sitemap.xml
            echo "  </url>" >> sitemap.xml
            
            count=$((count + 1))
            echo "å·²è™•ç†: $folder ($days_diff å¤©å‰ï¼Œå„ªå…ˆç´š: $priority)"
          fi
        done
        
        echo '</urlset>' >> sitemap.xml
        echo "Sitemap ç”Ÿæˆå®Œæˆï¼"
        echo "- éœæ…‹é é¢: 4 å€‹ï¼ˆé¦–é ã€RSSã€æœå°‹ã€æ–°èï¼‰"
        echo "- é€±å ±é é¢: $weekly_count å€‹ï¼ˆä¸å—365å¤©é™åˆ¶ï¼‰"
        echo "- æœˆå ±é é¢: $monthly_count å€‹ï¼ˆä¸å—365å¤©é™åˆ¶ï¼‰"
        echo "- æ—¥å ±é é¢: $count å€‹ï¼ˆ365å¤©å…§ï¼‰"
        echo "- ç¸½è¨ˆé é¢: $((count + weekly_count + monthly_count + 4)) å€‹"
        
    - name: Force commit sitemap
      run: |
        echo "=== Git ç‹€æ…‹æª¢æŸ¥ ==="
        git status
        echo ""
        
        # è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        echo "=== å¼·åˆ¶åŠ å…¥ sitemap.xml ==="
        # ç¢ºä¿æª”æ¡ˆè¢«è¿½è¹¤
        git add sitemap.xml --force
        git status
        
        echo "=== æäº¤è®Šæ›´ ==="
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æª”æ¡ˆè¢« stagedï¼Œå˜—è©¦å¼·åˆ¶åŠ å…¥..."
          ls -la sitemap.xml
          git add .
          git status
        fi
        
        # ç„¡è«–å¦‚ä½•éƒ½å˜—è©¦æäº¤
        git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–° sitemap (365å¤©å…§æ–‡ç« ) - $(date +'%Y-%m-%d %H:%M:%S')" || echo "æäº¤å¤±æ•—æˆ–æ²’æœ‰è®Šæ›´"
        
        echo "=== æ¨é€è®Šæ›´ ==="
        git push origin main || echo "æ¨é€å¤±æ•—"
        
        echo "=== æœ€çµ‚æª¢æŸ¥ ==="
        if [ -f "sitemap.xml" ]; then
          echo "âœ“ sitemap.xml å­˜åœ¨æ–¼å·¥ä½œç›®éŒ„"
        else
          echo "âœ— sitemap.xml ä¸å­˜åœ¨"
        fi
        
    - name: Display sitemap info
      run: |
        echo "=== Sitemap è³‡è¨Š ==="
        echo "æª”æ¡ˆå¤§å°: $(wc -c < sitemap.xml) bytes"
        echo "åŒ…å«é é¢æ•¸: $(grep -c '<loc>' sitemap.xml)"
        echo ""
        echo "é€±å ±åˆ—è¡¨:"
        grep '<loc>' sitemap.xml | grep '/weekly/' | sed 's/.*<loc>\(.*\)<\/loc>.*/  \1/'
        echo ""
        echo "æœˆå ±åˆ—è¡¨:"
        grep '<loc>' sitemap.xml | grep '/monthly/' | sed 's/.*<loc>\(.*\)<\/loc>.*/  \1/'
        echo ""
        echo "æœ€è¿‘10ç¯‡æ—¥å ±:"
        grep '<loc>' sitemap.xml | grep -E '/20[0-9]{2}/[0-9]{2}/[0-9]{2}/' | head -10 | sed 's/.*<loc>\(.*\)<\/loc>.*/  \1/'
        echo ""
        echo "Sitemap ä½ç½®: https://stock.may.tw/sitemap.xml"
        echo "ğŸ‰ Sitemap æ›´æ–°å®Œæˆï¼"
        echo "   - æ—¥å ±ï¼šåƒ…åŒ…å«365å¤©å…§æ–‡ç« ï¼ˆä¿æŒæ™‚æ•ˆæ€§ï¼‰"
        echo "   - é€±å ±/æœˆå ±ï¼šåŒ…å«æ‰€æœ‰å…§å®¹ï¼ˆé•·æœŸåƒè€ƒåƒ¹å€¼ï¼‰"
