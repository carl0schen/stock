name: Generate Sitemap

on:
  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
  push:
    branches: [ main ]
    paths:
      - '20*/index.html'  # åªæœ‰å°è‚¡è³‡æ–™æ›´æ–°æ‰è§¸ç™¼
      - '20*/**'          # æˆ–æ˜¯æ•´å€‹æ—¥æœŸè³‡æ–™å¤¾æœ‰è®Šå‹•
  
  # æ¯å¤©æ—©ä¸Šè‡ªå‹•åŸ·è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 1 * * *'  # UTC 1:00 AM (å°ç£æ™‚é–“ 9:00 AM)
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ï¼Œç”¨æ–¼æº–ç¢ºçš„ä¿®æ”¹æ™‚é–“
        
    - name: Generate sitemap
      run: |
        echo "é–‹å§‹ç”Ÿæˆ sitemap..."
        echo '<?xml version="1.0" encoding="UTF-8"?>' > sitemap.xml
        echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> sitemap.xml
        
        # è™•ç†é¦–é ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "index.html" ]; then
          last_mod=$(date -r index.html +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
          echo "  <url>" >> sitemap.xml
          echo "    <loc>https://stock.may.tw/</loc>" >> sitemap.xml
          echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
          echo "    <changefreq>daily</changefreq>" >> sitemap.xml
          echo "    <priority>1.0</priority>" >> sitemap.xml
          echo "  </url>" >> sitemap.xml
          echo "å·²åŠ å…¥é¦–é "
        fi
        
        # æ”¶é›†æ‰€æœ‰æ—¥æœŸè³‡æ–™å¤¾
        folders=()
        for dir in */; do
          # æª¢æŸ¥è³‡æ–™å¤¾åç¨±æ˜¯å¦ç¬¦åˆ YYYYMMDD æ ¼å¼
          if [[ ${dir%/} =~ ^[0-9]{8}$ ]] && [ -f "${dir}index.html" ]; then
            folders+=("${dir%/}")
          fi
        done
        
        # æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
        IFS=$'\n' sorted_folders=($(sort -r <<<"${folders[*]}"))
        unset IFS
        
        # ç‚ºæ¯å€‹è³‡æ–™å¤¾ç”Ÿæˆ sitemap æ¢ç›®
        count=0
        for folder in "${sorted_folders[@]}"; do
          if [ -f "${folder}/index.html" ]; then
            # ç²å–æª”æ¡ˆä¿®æ”¹æ™‚é–“
            last_mod=$(date -r "${folder}/index.html" +%Y-%m-%d 2>/dev/null || date +%Y-%m-%d)
            
            # è¨ˆç®—å¤©æ•¸å·®ç•°ä¾†è¨­å®šå„ªå…ˆç´šå’Œæ›´æ–°é »ç‡
            folder_date=$(date -d "${folder:0:4}-${folder:4:2}-${folder:6:2}" +%s 2>/dev/null || date +%s)
            current_date=$(date +%s)
            days_diff=$(( (current_date - folder_date) / 86400 ))
            
            # æ ¹æ“šè³‡æ–™æ–°èˆŠè¨­å®šåƒæ•¸
            if [ $days_diff -le 1 ]; then
              priority="1.0"
              changefreq="hourly"
            elif [ $days_diff -le 7 ]; then
              priority="0.9"
              changefreq="daily"
            elif [ $days_diff -le 30 ]; then
              priority="0.7"
              changefreq="weekly"
            else
              priority="0.5"
              changefreq="monthly"
            fi
            
            echo "  <url>" >> sitemap.xml
            echo "    <loc>https://stock.may.tw/$folder/</loc>" >> sitemap.xml
            echo "    <lastmod>$last_mod</lastmod>" >> sitemap.xml
            echo "    <changefreq>$changefreq</changefreq>" >> sitemap.xml
            echo "    <priority>$priority</priority>" >> sitemap.xml
            echo "  </url>" >> sitemap.xml
            
            count=$((count + 1))
            echo "å·²è™•ç†: $folder ($days_diff å¤©å‰)"
          fi
        done
        
        echo '</urlset>' >> sitemap.xml
        echo "Sitemap ç”Ÿæˆå®Œæˆï¼ŒåŒ…å« $count å€‹é é¢"
        
    - name: Commit and push sitemap
      run: |
        # è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet sitemap.xml; then
          echo "Sitemap æ²’æœ‰è®Šæ›´ï¼Œè·³éæäº¤"
        else
          git add sitemap.xml
          git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–° sitemap - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "Sitemap å·²æ›´æ–°ä¸¦æ¨é€"
        fi
        
    - name: Display sitemap info
      run: |
        echo "=== Sitemap è³‡è¨Š ==="
        echo "æª”æ¡ˆå¤§å°: $(wc -c < sitemap.xml) bytes"
        echo "åŒ…å«é é¢æ•¸: $(grep -c '<loc>' sitemap.xml)"
        echo "æœ€è¿‘5ç­†è³‡æ–™:"
        grep '<loc>' sitemap.xml | head -5 | sed 's/.*<loc>\(.*\)<\/loc>.*/  \1/'
        echo ""
        echo "Sitemap ä½ç½®: https://stock.may.tw/sitemap.xml"
